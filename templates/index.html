<!DOCTYPE html>
<html>
<head>
    <title>GPT Demo v0.1</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!--    <link href="css/default.css" type="text/css" rel="stylesheet"/>-->
    <!--    <script src="scripts/jquery-3.2.1.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style type="text/css">
        html{
            background-color:white;
        }

        body{
            width:390px;
            height:844px;
            overflow-x: hidden;
            overflow-y: hidden;
            margin:0 auto;
            background-color: #efefef;
        }

        #loadingContainer {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; /* å›ºå®šä½ç½®ï¼Œä½¿å…¶å§‹ç»ˆåœ¨è§†å£ä¸­å¤® */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(188, 188, 188, 0.8); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            opacity: 0;
            animation: fadeIn 1s forwards;

        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        #loadingContainer p::before {
            content: 'ğŸ”„'; /* ä½¿ç”¨æ—‹è½¬å›¾æ ‡ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å†…å®¹æˆ–å›¾ç‰‡ */
            display: block;
            font-size: 2em;
            margin-bottom: 10px;
            animation: spin 2s linear infinite; /* åº”ç”¨æ—‹è½¬åŠ¨ç”» */
        }
    </style>
</head>
<body>
<div>
    <div style="height:640px;width:384px;background-color:white;margin:40px auto">
        <img id="showImg" src="" alt="" style="height:640px;width:384px">
    </div>
    <div id="loadingContainer" style="display:none;">
        <p>Loading...</p>
        <!-- ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªGIFåŠ¨ç”» -->
    </div>
    <div id="btn_control"
         style="margin:20px auto;height:48px;width:120px;background-color:#0052d9;color: white;font-size: 18px;line-height: 48px;text-align: center;border-radius: 30px;cursor:pointer;"
         >ç”Ÿæˆå›¾ç‰‡
    </div>
    <div id="showText" style="margin:20px auto;text-align:center;color:white;">
    </div>

</div>

<script type="text/javascript">

    //å‡†å¤‡gptæ•°æ®
    $(document).ready(function() {
        $("#btn_control").click(function() {
            $("#showText").val("æ­£åœ¨è¯·æ±‚GPT...");

            //è¯·æ±‚GPT
            fetch('/generateGpt', {
                method: 'POST',
                body: JSON.stringify({
                    prompt: ''
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                //console.log(data.response);
                createPic(data.response);
                $("#showText").html(data.response);
            })
            .catch(err => {
                console.error("Fetch error: ", err);
            });
        });
    });

    //è¯·æ±‚ç”Ÿæˆå›¾ç‰‡
    function createPic(prompt) {
        $("#showText").html(prompt);
        $("#loadingContainer").show();// æ˜¾ç¤ºåŠ è½½å®¹å™¨

        fetch('/generateImg', {
            method: 'POST',
            body: JSON.stringify({
                prompt: prompt
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let accumulator = "";

            function processStream(reader, decoder, accumulator) {
                //console.log("Inside processStream");
                return reader.read().then(({ done, value }) => {
                    //console.log("Inside reader.read");
                    if (done) {
                        $("#loadingContainer").hide(); // éšè—åŠ è½½å®¹å™¨
                        console.log("Stream done");
                        return;
                    }
                    accumulator += decoder.decode(value);
                    //console.log("Accumulated value:", accumulator);
                    let lines = accumulator.split("\n");
                    //console.log("Accumulator content:", accumulator);
                    //console.log("Lines array:", lines);
                    for (let i = 0; i < lines.length - 1; i++) {
                        let message = lines[i];
                        console.log("Parsed message:", message);
                        if (message.includes('FI-URL:')) {
                            let imageUrl = message.split('FI-URL: ')[1].trim();
                            let baseUrl = window.location.protocol + "//" + window.location.host;
                            let fullUrl = baseUrl + imageUrl;
                            //console.log(fullUrl);
                            $("#showImg").attr("src", fullUrl);
                        }
                    }
                    accumulator = lines[lines.length - 1];
                    return processStream(reader, decoder, accumulator);
                });
            }

            return processStream(reader, decoder, accumulator);
        })
        .catch(err => {
            $("#loadingContainer").hide(); // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œéšè—åŠ è½½å®¹å™¨
            console.error("Fetch error: ", err);
        });
    }

    //éšè—loadingåŠ¨ç”»
    function hideLoadingContainer() {
        const loadingContainer = document.getElementById("loadingContainer");
        loadingContainer.style.animation = "fadeOut 1s forwards";
        setTimeout(() => {
            loadingContainer.style.display = "none";
        }, 1000);
    }

    //æ˜¾ç¤ºloadingåŠ¨ç”»
    function showLoadingContainer() {
        const loadingContainer = document.getElementById("loadingContainer");
        loadingContainer.style.display = "block";
        loadingContainer.style.animation = "fadeIn 1s forwards";
    }


</script>
</body>
</html>
